# SNMP入門

## SNMPとは

**SNMP（Simple Network Management Protocol）**は、ネットワーク機器を監視・管理するための標準プロトコルです。ルーター、スイッチ、サーバーなどのネットワーク機器の状態を取得・設定変更するために使用されます。

## なぜSNMPが必要なのか

### 問題
- ネットワーク機器が多数存在
- 手動での監視・管理は非効率
- 障害の早期発見が困難
- 設定変更の一元管理ができない

### 解決策
SNMPを使用することで、ネットワーク全体を統一的に監視・管理し、効率的な運用が可能になります。

## SNMPの基本構成

### 3つの主要コンポーネント

```
[管理システム] ←→ [SNMPエージェント] ←→ [管理対象機器]
     ↑                    ↑                    ↑
   NMS              SNMPエージェント        ルーター/スイッチ
```

| コンポーネント | 役割 | 例 |
|---------------|------|-----|
| **NMS** | ネットワーク管理システム | 監視ソフトウェア |
| **SNMPエージェント** | 管理対象機器の情報提供 | ルーター内のSNMP機能 |
| **管理対象機器** | 実際のネットワーク機器 | スイッチ、サーバー |

## SNMPのバージョン

### SNMPv1
- **特徴**: 最初のバージョン、シンプル
- **認証**: コミュニティ文字列のみ
- **セキュリティ**: 暗号化なし
- **用途**: 内部ネットワーク

### SNMPv2c
- **特徴**: パフォーマンス向上
- **認証**: コミュニティ文字列
- **セキュリティ**: 暗号化なし
- **用途**: 一般的に使用

### SNMPv3
- **特徴**: セキュリティ強化
- **認証**: ユーザー名・パスワード
- **セキュリティ**: 暗号化対応
- **用途**: 本格的な運用

## MIB（Management Information Base）

### MIBとは
ネットワーク機器の管理情報を階層的に定義したデータベースです。

### MIBツリー構造
```
iso(1)
 └── org(3)
     └── dod(6)
         └── internet(1)
             ├── mgmt(2)
             │   └── mib-2(1)
             │       ├── system(1)
             │       ├── interfaces(2)
             │       └── ip(4)
             └── private(4)
                 └── enterprises(1)
```

### 主要なMIBオブジェクト

| OID | 名前 | 説明 |
|-----|------|------|
| 1.3.6.1.2.1.1.1.0 | sysDescr | システムの説明 |
| 1.3.6.1.2.1.1.3.0 | sysUpTime | システム稼働時間 |
| 1.3.6.1.2.1.2.2.1.2 | ifDescr | インターフェースの説明 |
| 1.3.6.1.2.1.4.20.1.1 | ipAdEntAddr | IPアドレス |

## SNMP操作

### 5つの基本操作

| 操作 | 説明 | 用途 |
|------|------|------|
| **GET** | 単一の値を取得 | 現在の状態確認 |
| **GET-NEXT** | 次の値を取得 | テーブルの走査 |
| **GET-BULK** | 複数の値を一括取得 | 効率的なデータ収集 |
| **SET** | 値を設定 | 設定変更 |
| **TRAP** | 通知を送信 | イベント通知 |

### 操作の例

#### GET操作
```
GET 1.3.6.1.2.1.1.1.0
→ システムの説明を取得
```

#### SET操作
```
SET 1.3.6.1.2.1.1.4.0 = "管理者名"
→ システムの連絡先を設定
```

## コミュニティ文字列

### 読み取り専用（RO）
- **用途**: 情報の取得のみ
- **例**: `public`
- **権限**: GET操作のみ

### 読み書き（RW）
- **用途**: 情報の取得・設定変更
- **例**: `private`
- **権限**: GET/SET操作

## 実装例

### 基本的なSNMPクエリ
```bash
# システムの説明を取得
snmpget -v2c -c public 192.168.1.1 1.3.6.1.2.1.1.1.0

# システムの稼働時間を取得
snmpget -v2c -c public 192.168.1.1 1.3.6.1.2.1.1.3.0

# インターフェース一覧を取得
snmpwalk -v2c -c public 192.168.1.1 1.3.6.1.2.1.2.2.1.2
```

### Pythonでの実装例
```python
from pysnmp.hlapi import *

# SNMP GET操作
def snmp_get(host, community, oid):
    for (errorIndication, errorStatus, errorIndex, varBinds) in nextCmd(
        SnmpEngine(),
        CommunityData(community),
        UdpTransportTarget((host, 161)),
        ContextData(),
        ObjectType(ObjectIdentity(oid)),
        lexicographicMode=False):
        
        if errorIndication:
            print(errorIndication)
            break
        elif errorStatus:
            print('%s at %s' % (errorStatus.prettyPrint(),
                                errorIndex and varBinds[int(errorIndex) - 1][0] or '?'))
            break
        else:
            for varBind in varBinds:
                print(' = '.join([x.prettyPrint() for x in varBind]))

# 使用例
snmp_get('192.168.1.1', 'public', '1.3.6.1.2.1.1.1.0')
```

## 監視項目

### システム情報
- システムの説明
- 稼働時間
- 連絡先情報
- システム名

### ネットワーク情報
- インターフェース状態
- トラフィック統計
- エラーカウンタ
- IPアドレス情報

### リソース情報
- CPU使用率
- メモリ使用量
- ディスク使用量
- 温度情報

## セキュリティ考慮事項

### 1. コミュニティ文字列の管理
- デフォルト値の変更
- 複雑な文字列の使用
- 定期的な変更

### 2. アクセス制御
- 特定のIPアドレスのみ許可
- 読み取り専用の使用
- ファイアウォールでの制限

### 3. SNMPv3の活用
- ユーザー認証
- データ暗号化
- アクセス制御

## 運用のベストプラクティス

### 1. 監視設計
- 重要な指標の特定
- 閾値の設定
- アラートの設定

### 2. データ管理
- ログの保存
- データの分析
- レポートの作成

### 3. 障害対応
- アラートの確認
- 原因の特定
- 復旧作業

## まとめ

SNMPは、ネットワーク管理の標準的なプロトコルで、効率的なネットワーク運用に不可欠です。適切に設定・運用することで、ネットワークの可用性とパフォーマンスを向上させることができます。

### 次のステップ
- 監視ツールの導入
- カスタムMIBの作成
- 自動化スクリプトの開発
- セキュリティ強化の実装
