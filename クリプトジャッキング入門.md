# クリプトジャッキング入門

## クリプトジャッキングとは

**クリプトジャッキング（Cryptojacking）**は、他人のコンピュータやデバイスを無断で使用して仮想通貨（暗号通貨）のマイニングを行う攻撃手法です。攻撃者は被害者のデバイスのCPUやGPUリソースを盗用し、自分自身の利益のために仮想通貨を採掘します。

## なぜクリプトジャッキングが発生するのか

### 背景
- **仮想通貨の価値上昇**: ビットコインなどの価格高騰
- **マイニングの複雑化**: 個人での採掘が困難
- **低コストでの攻撃**: 他人のリソースを利用
- **検出の困難さ**: 通常の使用と区別が困難

### 攻撃者の動機
- **経済的利益**: 無料でマイニングを実行
- **リスクの回避**: 自分でハードウェアを購入する必要がない
- **匿名性**: 被害者に気づかれにくい
- **スケーラビリティ**: 多数のデバイスを同時に攻撃

## クリプトジャッキングの種類

### 1. ブラウザベース攻撃

| 特徴 | 説明 | 例 |
|------|------|-----|
| **JavaScript** | ブラウザで実行 | 悪意のあるWebサイト |
| **一時的** | ページを閉じると停止 | 広告、埋め込みスクリプト |
| **検出困難** | 正常なWebサイトと区別困難 | 正規サイトの改ざん |

### 2. マルウェアベース攻撃

| 特徴 | 説明 | 例 |
|------|------|-----|
| **永続的** | システムに常駐 | トロイの木馬、ウイルス |
| **高効率** | より多くのリソースを使用 | 専用マイニングマルウェア |
| **隠蔽性** | プロセス名を偽装 | システムプロセスに偽装 |

### 3. クラウドベース攻撃

| 特徴 | 説明 | 例 |
|------|------|-----|
| **高リソース** | クラウドの高性能マシンを利用 | AWS、Azure、GCP |
| **高収益** | 大量のリソースで効率的 | 不正アクセス、設定ミス |
| **検出困難** | クラウド環境での監視が困難 | 管理者権限の悪用 |

## 攻撃の手順

### 1. ブラウザベース攻撃
```
[悪意のあるWebサイト] → [JavaScript実行] → [マイニング開始] → [収益獲得]
```

### 2. マルウェアベース攻撃
```
[マルウェア感染] → [システム常駐] → [マイニング開始] → [収益獲得]
```

### 3. クラウドベース攻撃
```
[クラウドアクセス] → [リソース確保] → [マイニング開始] → [収益獲得]
```

## 攻撃に使用される技術

### 1. マイニングプール
```javascript
// ブラウザでのマイニング例（教育目的）
const miner = new CoinHive.Anonymous('your-site-key');
miner.start();
miner.on('found', function() {
    console.log('Hash found!');
});
miner.on('accepted', function() {
    console.log('Hash accepted!');
});
```

### 2. WebAssembly
```javascript
// WebAssemblyを使用したマイニング
const wasmMiner = new WebAssembly.Memory({
    initial: 256,
    maximum: 256
});
```

### 3. プロセス偽装
```python
# プロセス名を偽装する例（教育目的）
import psutil
import os

def disguise_mining_process():
    """マイニングプロセスを偽装"""
    # プロセス名をシステムプロセスに偽装
    os.rename('miner.exe', 'svchost.exe')
    
    # プロセスの優先度を下げる
    process = psutil.Process()
    process.nice(19)  # 最低優先度
```

## 攻撃の検出方法

### 1. リソース監視
```python
# CPU使用率の監視
import psutil
import time

def monitor_cpu_usage():
    """CPU使用率を監視して異常を検出"""
    while True:
        cpu_percent = psutil.cpu_percent(interval=1)
        
        if cpu_percent > 80:  # 閾値
            print(f"高CPU使用率を検出: {cpu_percent}%")
            # アラートを送信
            send_alert(f"CPU使用率が異常: {cpu_percent}%")
        
        time.sleep(5)

def send_alert(message):
    """セキュリティアラートを送信"""
    # アラート送信の実装
    pass
```

### 2. ネットワーク監視
```python
# ネットワーク接続の監視
import socket
import requests

def monitor_network_connections():
    """ネットワーク接続を監視してマイニングプールを検出"""
    # 既知のマイニングプールのドメイン
    mining_pools = [
        'stratum+tcp://pool.example.com:4444',
        'stratum+tcp://mining.example.com:3333'
    ]
    
    # アクティブな接続を確認
    connections = psutil.net_connections()
    
    for conn in connections:
        if conn.raddr and conn.raddr.port in [4444, 3333]:
            print(f"マイニングプールへの接続を検出: {conn.raddr}")
            send_alert("マイニングプールへの接続を検出")
```

### 3. プロセス監視
```python
# プロセスの監視
def monitor_processes():
    """プロセスを監視してマイニングソフトウェアを検出"""
    # 既知のマイニングソフトウェア
    mining_processes = [
        'xmrig.exe', 'minerd.exe', 'ccminer.exe',
        'cgminer.exe', 'bfgminer.exe'
    ]
    
    for proc in psutil.process_iter(['pid', 'name', 'cmdline']):
        try:
            if proc.info['name'] in mining_processes:
                print(f"マイニングプロセスを検出: {proc.info['name']}")
                send_alert(f"マイニングプロセスを検出: {proc.info['name']}")
        except (psutil.NoSuchProcess, psutil.AccessDenied):
            pass
```

## 防御対策

### 1. ブラウザでの対策

#### アドブロッカーの使用
```javascript
// uBlock Originの設定例
// マイニングスクリプトをブロック
||coin-hive.com^
||cryptonight.wasm^
||miner.js^
```

#### ブラウザ拡張機能
- **No Coin**: マイニングスクリプトをブロック
- **MinerBlock**: クリプトジャッキングを防止
- **uBlock Origin**: 広告ブロッカーでマイニングもブロック

### 2. システムでの対策

#### アンチウイルスソフト
```bash
# ClamAVでのスキャン例
clamscan -r /home/user/ --include="*.exe,*.js,*.wasm"

# リアルタイム監視の有効化
clamd --foreground
```

#### ファイアウォール設定
```bash
# iptablesでのマイニングプールブロック
iptables -A OUTPUT -d 192.168.1.0/24 -j ACCEPT
iptables -A OUTPUT -p tcp --dport 4444 -j DROP
iptables -A OUTPUT -p tcp --dport 3333 -j DROP
```

### 3. ネットワークでの対策

#### DNSフィルタリング
```bash
# /etc/hostsでのブロック例
127.0.0.1 coin-hive.com
127.0.0.1 cryptonight.wasm
127.0.0.1 miner.js
```

#### プロキシサーバー
```python
# プロキシサーバーでのフィルタリング例
from mitmproxy import http

def request(flow: http.HTTPFlow) -> None:
    # マイニング関連のリクエストをブロック
    if 'coin-hive' in flow.request.pretty_host:
        flow.response = http.Response.make(
            403, b"Blocked: Cryptocurrency mining detected"
        )
```

## 被害の影響

### 1. 直接的な影響
- **CPU使用率の上昇**: システムの動作が遅くなる
- **電力消費の増加**: 電気代の上昇
- **発熱の増加**: デバイスの寿命短縮
- **バッテリー消費**: モバイルデバイスの電池切れ

### 2. 間接的な影響
- **生産性の低下**: 作業効率の悪化
- **セキュリティリスク**: 他のマルウェアの侵入経路
- **データ漏洩**: 個人情報の盗用
- **法的リスク**: 不正アクセスの疑い

## 法的・規制面

### 1. 日本の法律
- **不正アクセス行為の禁止等に関する法律**: 不正アクセスの禁止
- **刑法**: 電子計算機損壊等業務妨害罪
- **個人情報保護法**: 個人情報の保護

### 2. 国際的な対応
- **GDPR**: 欧州のデータ保護規制
- **CCPA**: カリフォルニア州のプライバシー法
- **各国の仮想通貨規制**: 仮想通貨の取引規制

## 実際の事例

### 1. 大規模な攻撃事例
- **2017年**: Coinhiveの普及
- **2018年**: 政府機関への攻撃
- **2019年**: クラウド環境での攻撃
- **2020年**: コロナ禍での増加

### 2. 攻撃の傾向
- **ブラウザベース**: 一時的な攻撃の増加
- **マルウェアベース**: 永続的な攻撃の増加
- **クラウドベース**: 高収益を狙った攻撃
- **モバイル**: スマートフォンでの攻撃

## まとめ

クリプトジャッキングは、他人のリソースを無断で使用する深刻なサイバー攻撃です。適切な対策により、被害を防ぐことができます。

### 次のステップ
- セキュリティソフトの導入
- ブラウザの設定強化
- ネットワーク監視の実装
- 従業員の教育・訓練
