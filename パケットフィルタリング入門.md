# パケットフィルタリング入門 - ネットワークセキュリティの基本技術を理解する

## 目次
1. [パケットフィルタリングとは何か](#パケットフィルタリングとは何か)
2. [パケットの構造とヘッダー情報](#パケットの構造とヘッダー情報)
3. [パケットフィルタリングの動作メカニズム](#パケットフィルタリングの動作メカニズム)
4. [フィルタリングの判定基準](#フィルタリングの判定基準)
5. [パケットフィルタリングの実装方法](#パケットフィルタリングの実装方法)
6. [セキュリティ上の考慮事項](#セキュリティ上の考慮事項)
7. [パケットフィルタリングのベストプラクティス](#パケットフィルタリングのベストプラクティス)
8. [トラブルシューティングとデバッグ](#トラブルシューティングとデバッグ)
9. [まとめ](#まとめ)

---

## パケットフィルタリングとは何か

### 基本定義
**パケットフィルタリング（Packet Filtering）**は、ネットワーク上を流れるパケットを検査し、事前に定義されたルールに基づいて通過を許可または拒否する技術です。これはネットワークセキュリティの基本的な防御手段の一つです。

### パケットフィルタリングの目的
- **アクセス制御**: 許可された通信のみを通し、不正な通信をブロック
- **セキュリティ強化**: 悪意のあるトラフィックからの保護
- **帯域制御**: ネットワークリソースの効率的な利用
- **ポリシー適用**: 組織のセキュリティポリシーの実装

### パケットフィルタリングの特徴

#### 利点
- **高速処理**: シンプルな判定ロジックによる高速処理
- **低リソース**: 最小限のCPU・メモリ使用量
- **透明性**: アプリケーションに影響を与えない
- **柔軟性**: 細かい制御が可能

#### 制限事項
- **限定的な検査**: パケットヘッダーのみを検査
- **アプリケーション非対応**: アプリケーションレベルの制御は困難
- **設定の複雑さ**: 適切なルール設定には専門知識が必要
- **偽装攻撃**: IPアドレス偽装などの攻撃には対応困難

### パケットフィルタリングの位置づけ

```
アプリケーション層 (HTTP, FTP, SMTP)
    ↓
トランスポート層 (TCP, UDP)
    ↓
ネットワーク層 (IP) ← パケットフィルタリングの主な対象
    ↓
データリンク層 (Ethernet)
    ↓
物理層
```

---

## パケットの構造とヘッダー情報

### パケットの基本構造

#### 一般的なパケット構成
```
┌─────────────────────────────────────────┐
│            Ethernet Header              │
├─────────────────────────────────────────┤
│               IP Header                 │
├─────────────────────────────────────────┤
│            TCP/UDP Header               │
├─────────────────────────────────────────┤
│              Data Payload               │
└─────────────────────────────────────────┘
```

### IPヘッダー（ネットワーク層）

#### IPヘッダーの構造
```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Version|  IHL  |Type of Service|          Total Length         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         Identification        |Flags|      Fragment Offset    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Time to Live |    Protocol   |         Header Checksum       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       Source Address                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Destination Address                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

#### 重要なフィールド
- **Source Address（送信元IP）**: パケットの送信元IPアドレス
- **Destination Address（宛先IP）**: パケットの宛先IPアドレス
- **Protocol（プロトコル）**: 上位プロトコル（TCP=6, UDP=17, ICMP=1）
- **Time to Live（TTL）**: パケットの生存時間

### TCPヘッダー（トランスポート層）

#### TCPヘッダーの構造
```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          Source Port          |       Destination Port        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        Sequence Number                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Acknowledgment Number                      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Data |           |U|A|P|R|S|F|                               |
| Offset| Reserved  |R|C|S|S|Y|I|            Window             |
|       |           |G|K|H|T|N|N|                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

#### 重要なフィールド
- **Source Port（送信元ポート）**: 送信元のポート番号
- **Destination Port（宛先ポート）**: 宛先のポート番号
- **Flags（フラグ）**: 接続制御情報（SYN, ACK, FIN, RST等）

### UDPヘッダー（トランスポート層）

#### UDPヘッダーの構造
```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          Source Port          |       Destination Port        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|            Length             |           Checksum            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

#### 重要なフィールド
- **Source Port（送信元ポート）**: 送信元のポート番号
- **Destination Port（宛先ポート）**: 宛先のポート番号
- **Length（長さ）**: UDPヘッダーとデータの合計長

---

## パケットフィルタリングの動作メカニズム

### 基本的な動作フロー

```
1. パケット受信
   ↓
2. ヘッダー情報の抽出
   ↓
3. ルールとの照合
   ↓
4. 判定実行
   ↓
5. アクション実行（許可/拒否/ログ）
```

### ルールベースの判定

#### ルールの基本構造
```
アクション  送信元  宛先  プロトコル  ポート  オプション
```

#### ルールの例
```
# WebサーバーへのHTTPアクセスを許可
ALLOW  ANY  →  192.168.1.100   TCP  80

# SSHアクセスを特定ネットワークからのみ許可
ALLOW  192.168.0.0/24  →  ANY  TCP  22

# すべてのその他の通信を拒否
DENY  ANY  →  ANY  ANY  ANY
```

### ルールの評価順序

#### 重要: ルールの順序が重要
```
ルール1: ALLOW  192.168.1.0/24  →  ANY  TCP  80    # Webアクセス許可
ルール2: DENY   ANY  →  ANY  ANY  ANY              # その他拒否

→ ルール1が先に評価されるため、192.168.1.0/24からのWebアクセスは許可される
```

#### 最適化のポイント
```
1. 頻繁に使用されるルールを上位に配置
2. 特定のルールを一般的なルールより上位に配置
3. デフォルト拒否ルールを最後に配置
```

### ステートフル vs ステートレス

#### ステートレスフィルタリング
- **特徴**: 各パケットを独立して判定
- **判定**: パケットヘッダーの情報のみ
- **例**: 単純なパケットフィルタリング

```
例: 80番ポートへのアクセスを許可
→ 送信・受信の両方向で個別にルールが必要
```

#### ステートフルフィルタリング
- **特徴**: 接続の状態を追跡して判定
- **判定**: 接続状態とパケットヘッダー情報
- **例**: 接続確立後の応答パケットを自動許可

```
例: 内部から外部へのHTTP接続を許可
→ その応答パケットは自動的に許可される
```

---

## フィルタリングの判定基準

### 1. IPアドレスによる判定

#### 単一IPアドレス
```
# 特定のIPアドレスからのアクセスを許可
ALLOW  192.168.1.100  →  ANY  ANY  ANY
```

#### ネットワーク範囲
```
# 特定のネットワークからのアクセスを許可
ALLOW  192.168.1.0/24  →  ANY  ANY  ANY

# 複数のネットワーク
ALLOW  192.168.1.0/24, 10.0.0.0/8  →  ANY  ANY  ANY
```

#### 除外設定
```
# 特定のIPアドレスを除外
ALLOW  192.168.1.0/24  →  ANY  ANY  ANY  EXCEPT  192.168.1.50
```

### 2. ポート番号による判定

#### 単一ポート
```
# HTTPアクセス（80番ポート）を許可
ALLOW  ANY  →  ANY  TCP  80
```

#### ポート範囲
```
# ポート範囲での許可
ALLOW  ANY  →  ANY  TCP  1024-65535
```

#### 複数ポート
```
# 複数のポートを許可
ALLOW  ANY  →  ANY  TCP  80,443,8080
```

#### よく使用されるポート番号
```
20,21    FTP
22       SSH
23       Telnet
25       SMTP
53       DNS
80       HTTP
110      POP3
143      IMAP
443      HTTPS
993      IMAPS
995      POP3S
```

### 3. プロトコルによる判定

#### 主要プロトコル
```
TCP     信頼性のある通信（HTTP, HTTPS, SSH, SMTP等）
UDP     高速通信（DNS, DHCP, SNMP等）
ICMP    制御メッセージ（ping, traceroute等）
GRE     トンネリングプロトコル
ESP     暗号化通信（IPsec）
```

#### プロトコル別の制御例
```
# ICMPを制限（ping攻撃対策）
ALLOW  ANY  →  ANY  ICMP  echo-request  LIMIT  10/minute
DENY   ANY  →  ANY  ICMP  ANY

# GREトンネルを許可
ALLOW  192.168.1.0/24  →  10.0.0.0/8  GRE  ANY
```

### 4. フラグによる判定（TCP）

#### TCPフラグの種類
```
SYN    接続開始
ACK    確認応答
FIN    接続終了
RST    接続リセット
PSH    データプッシュ
URG    緊急データ
```

#### フラグによる制御例
```
# SYNフラグのみのパケットを制限（SYN攻撃対策）
ALLOW  ANY  →  ANY  TCP  ANY  FLAGS  SYN  LIMIT  5/second
DENY   ANY  →  ANY  TCP  ANY  FLAGS  SYN

# 確立された接続のみ許可
ALLOW  ANY  →  ANY  TCP  ANY  FLAGS  ACK
```

### 5. 時間による判定

#### 時間帯制御
```
# 業務時間のみアクセス許可
ALLOW  ANY  →  ANY  ANY  ANY  TIME  09:00-18:00  WEEKDAYS

# 夜間のアクセス制限
DENY   ANY  →  ANY  ANY  ANY  TIME  22:00-06:00
```

#### 日付制御
```
# 特定の日付のみ許可
ALLOW  ANY  →  ANY  ANY  ANY  DATE  2024-01-01
```

---

## パケットフィルタリングの実装方法

### 1. ハードウェアベースの実装

#### 専用ファイアウォール
- **Cisco ASA**: エンタープライズ向け
- **Fortinet FortiGate**: 統合セキュリティプラットフォーム
- **Palo Alto Networks**: 次世代ファイアウォール
- **Check Point**: エンタープライズセキュリティ

#### ルーターでの実装
```
# Cisco IOS の例
access-list 100 permit tcp 192.168.1.0 0.0.0.255 any eq 80
access-list 100 permit tcp 192.168.1.0 0.0.0.255 any eq 443
access-list 100 deny ip any any
```

### 2. ソフトウェアベースの実装

#### Linux iptables
```bash
# 基本的なiptablesルール
# WebサーバーへのHTTPアクセスを許可
iptables -A INPUT -p tcp --dport 80 -j ACCEPT

# SSHアクセスを特定ネットワークからのみ許可
iptables -A INPUT -p tcp -s 192.168.1.0/24 --dport 22 -j ACCEPT

# その他すべて拒否
iptables -A INPUT -j DROP

# ルールの確認
iptables -L -n -v
```

#### Windows Firewall
```powershell
# PowerShellでのWindows Firewall設定
# HTTPアクセスを許可
New-NetFirewallRule -DisplayName "Allow HTTP" -Direction Inbound -Protocol TCP -LocalPort 80 -Action Allow

# 特定IPからのSSHアクセスを許可
New-NetFirewallRule -DisplayName "Allow SSH from Internal" -Direction Inbound -Protocol TCP -LocalPort 22 -RemoteAddress 192.168.1.0/24 -Action Allow
```

#### pfSense（FreeBSD）
```
# pfSenseのルール例
# Webサーバーへのアクセス
pass in on $WAN proto tcp to $WEB_SERVER port 80
pass in on $WAN proto tcp to $WEB_SERVER port 443

# 内部ネットワークからのSSH
pass in on $LAN proto tcp to any port 22
```

### 3. クラウドベースの実装

#### AWS Security Groups
```json
{
  "SecurityGroupRules": [
    {
      "IpProtocol": "tcp",
      "FromPort": 80,
      "ToPort": 80,
      "IpRanges": [{"CidrIp": "0.0.0.0/0"}]
    },
    {
      "IpProtocol": "tcp",
      "FromPort": 22,
      "ToPort": 22,
      "IpRanges": [{"CidrIp": "192.168.1.0/24"}]
    }
  ]
}
```

#### Azure Network Security Groups
```json
{
  "securityRules": [
    {
      "name": "Allow-HTTP",
      "properties": {
        "protocol": "Tcp",
        "sourcePortRange": "*",
        "destinationPortRange": "80",
        "sourceAddressPrefix": "*",
        "destinationAddressPrefix": "*",
        "access": "Allow",
        "priority": 1000,
        "direction": "Inbound"
      }
    }
  ]
}
```

### 4. 実装時の考慮事項

#### パフォーマンス最適化
```
1. ルールの最適化
   - 頻繁に使用されるルールを上位に配置
   - 不要なルールの削除
   - ルールの統合

2. ハードウェアリソース
   - CPU使用率の監視
   - メモリ使用量の確認
   - ネットワーク帯域の確保

3. キャッシュの活用
   - ルールキャッシュの有効化
   - 接続状態のキャッシュ
```

#### 可用性の確保
```
1. 冗長化
   - アクティブ-スタンバイ構成
   - ロードバランサーとの連携

2. フェイルオープン/フェイルクローズ
   - 障害時の動作方針の決定
   - 自動復旧機能の実装
```

---

## セキュリティ上の考慮事項

### 1. 一般的な攻撃と対策

#### IPアドレス偽装攻撃
```
攻撃手法: 送信元IPアドレスを偽装して攻撃
対策:
- 送信元IPアドレスの検証
- 逆引きDNSの確認
- 地理的制限の適用
```

#### ポートスキャン攻撃
```
攻撃手法: 複数のポートに順次アクセスしてサービスを探索
対策:
- 不要なポートの閉鎖
- ポートスキャンの検出とブロック
- レート制限の適用
```

#### SYN攻撃（SYN Flood）
```
攻撃手法: 大量のSYNパケットを送信してリソースを枯渇
対策:
- SYNクッキーの有効化
- 接続数の制限
- タイムアウト値の調整
```

#### DDoS攻撃
```
攻撃手法: 大量のトラフィックでサービスを妨害
対策:
- レート制限の適用
- 異常トラフィックの検出
- CDNとの連携
```

### 2. セキュリティ強化のポイント

#### 最小権限の原則
```
基本方針: 必要最小限のアクセスのみ許可

例:
- Webサーバー: 80, 443番ポートのみ
- メールサーバー: 25, 110, 143, 993, 995番ポートのみ
- データベース: 内部ネットワークからのみアクセス可能
```

#### デフォルト拒否の原則
```
1. すべての通信をデフォルトで拒否
2. 明示的に許可された通信のみ通過
3. 定期的なルールの見直し
```

#### 多層防御
```
1. ネットワークレベル: パケットフィルタリング
2. ホストレベル: ホストファイアウォール
3. アプリケーションレベル: WAF
4. データレベル: 暗号化
```

### 3. ログとモニタリング

#### 重要なログ項目
```
1. タイムスタンプ
2. 送信元IPアドレス
3. 宛先IPアドレス
4. プロトコル
5. ポート番号
6. アクション（許可/拒否）
7. ルール番号
8. パケットサイズ
```

#### 監視のポイント
```
1. 異常な通信量
2. 未知のIPアドレスからのアクセス
3. 禁止されたプロトコルの使用
4. 大量の接続試行
5. 地理的に異常なアクセス
```

---

## パケットフィルタリングのベストプラクティス

### 1. ルール設計のベストプラクティス

#### ルールの整理
```
1. ルールの論理的な順序
   - 特定のルールを先に配置
   - 一般的なルールを後に配置

2. ルールの文書化
   - 各ルールの目的を明記
   - 作成者と作成日を記録
   - 定期的な見直しスケジュール

3. ルールのテスト
   - ステージング環境でのテスト
   - 段階的な本番適用
```

#### ルールの例
```
# ルール1: 管理用SSHアクセス（特定IPからのみ）
ALLOW  192.168.1.0/24  →  ANY:22  TCP  # 管理用

# ルール2: WebサーバーへのHTTP/HTTPSアクセス
ALLOW  ANY  →  192.168.1.100:80,443  TCP  # Webサービス

# ルール3: 内部DNSサーバーへのアクセス
ALLOW  192.168.0.0/16  →  192.168.1.10:53  UDP  # DNS

# ルール4: その他すべて拒否
DENY  ANY  →  ANY  ANY  # デフォルト拒否
```

### 2. 運用管理のベストプラクティス

#### 定期的なメンテナンス
```
1. ルールの見直し（四半期ごと）
2. ログの分析（月次）
3. セキュリティアップデート（月次）
4. バックアップの取得（週次）
5. 災害復旧計画のテスト（年次）
```

#### 監視とアラート
```
1. リアルタイム監視
   - 異常な通信パターン
   - 攻撃の検出
   - システムの状態

2. アラート設定
   - 重大なセキュリティイベント
   - システム障害
   - 容量不足
```

### 3. セキュリティ強化のポイント

#### 定期的なセキュリティ評価
```
1. 脆弱性スキャン
2. ペネトレーションテスト
3. セキュリティ監査
4. インシデント対応訓練
```

#### 継続的な改善
```
1. 脅威インテリジェンスの活用
2. 新しい攻撃手法への対応
3. 技術の進歩への適応
4. ベストプラクティスの更新
```

---

## トラブルシューティングとデバッグ

### 1. 一般的な問題と解決方法

#### 接続できない問題

##### 症状
- 特定のサービスにアクセスできない
- 外部からの接続が失敗する
- 内部からの外部アクセスができない

##### 診断手順
```
1. ルールの確認
   - 該当するルールが存在するか
   - ルールの順序は正しいか
   - ルールの条件は適切か

2. ログの確認
   - パケットがブロックされているか
   - エラーメッセージの確認
   - タイムスタンプの確認

3. ネットワークの確認
   - ルーティングの確認
   - DNSの解決確認
   - 物理的な接続確認
```

##### 解決方法
```
1. ルールの修正
   - 不足しているルールの追加
   - 間違ったルールの修正
   - ルールの順序変更

2. 一時的な許可
   - テスト用の一時ルール追加
   - 問題解決後のルール削除
```

#### パフォーマンスの問題

##### 症状
- 通信速度が遅い
- ファイアウォールのCPU使用率が高い
- メモリ使用量が多い

##### 原因と対策
```
1. ルールの最適化
   - 頻繁に使用されるルールを上位に配置
   - 不要なルールの削除
   - ルールの統合

2. ハードウェアの見直し
   - CPU/メモリの増強
   - ネットワークインターフェースの見直し
   - 専用ハードウェアの検討

3. 設定の最適化
   - ログレベルの調整
   - 不要な機能の無効化
   - キャッシュの活用
```

### 2. デバッグツールと手法

#### パケットキャプチャツール
```
1. tcpdump（Linux/Unix）
   tcpdump -i eth0 -n host 192.168.1.100

2. Wireshark（GUI）
   - グラフィカルなパケット解析
   - プロトコル解析機能
   - 統計情報の表示

3. netstat（接続状態確認）
   netstat -an | grep :80
```

#### ログ分析ツール
```
1. 標準ツール
   - grep, awk, sed（Linux/Unix）
   - PowerShell（Windows）
   - Excel（小規模データ）

2. 専用ツール
   - Splunk
   - ELK Stack（Elasticsearch, Logstash, Kibana）
   - Graylog
```

#### ネットワーク診断ツール
```
1. ping（接続性確認）
   ping 192.168.1.100

2. traceroute（経路確認）
   traceroute 192.168.1.100

3. telnet（ポート確認）
   telnet 192.168.1.100 80

4. nmap（ポートスキャン）
   nmap -p 80,443 192.168.1.100
```

### 3. 緊急時の対応

#### インシデント発生時の手順
```
1. 即座の対応
   - 攻撃の遮断
   - 影響範囲の特定
   - 関係者への連絡

2. 調査と分析
   - ログの収集
   - 攻撃手法の分析
   - 被害の評価

3. 復旧と対策
   - 脆弱性の修正
   - ルールの更新
   - セキュリティ強化

4. 事後対応
   - 報告書の作成
   - 再発防止策の策定
   - 訓練の実施
```

---

## まとめ

### パケットフィルタリングの重要性
パケットフィルタリングはネットワークセキュリティの基本技術として、現代のIT環境において不可欠な要素です。適切に実装・運用することで、組織の情報資産を効果的に保護できます。

### 成功のポイント
1. **適切な設計**: 組織の要件に合ったフィルタリングルールの設計
2. **適切な実装**: セキュリティポリシーに基づくルールの実装
3. **継続的な管理**: 定期的な見直しと更新
4. **監視と対応**: リアルタイム監視とインシデント対応

### 技術の進歩
- **AI/MLの活用**: 機械学習による異常検知の高度化
- **クラウド統合**: クラウド環境との統合強化
- **ゼロトラスト**: ゼロトラストセキュリティモデルへの対応
- **IoT対応**: IoTデバイス向けの軽量フィルタリング

### 学習の継続
パケットフィルタリング技術は継続的に進歩しています。最新の脅威と対策について常に学習し、実践的なスキルを身につけることが重要です。

---

## 参考資料

### 公式ドキュメント
- [RFC 2979: Behavior of and Requirements for Internet Firewalls](https://tools.ietf.org/html/rfc2979)
- [NIST SP 800-41: Guidelines on Firewalls and Firewall Policy](https://csrc.nist.gov/publications/detail/sp/800-41/rev-1/final)
- [CIS Controls: Firewall Management](https://www.cisecurity.org/controls/)

### 学習リソース
- [iptables Tutorial](https://www.netfilter.org/documentation/)
- [Cisco ASA Configuration Guide](https://www.cisco.com/c/en/us/support/security/asa-firewall-services/products-installation-and-configuration-guides-list.html)
- [pfSense Documentation](https://docs.netgate.com/pfsense/)

### セキュリティ情報
- [CVE Database](https://cve.mitre.org/)
- [NIST National Vulnerability Database](https://nvd.nist.gov/)
- [SANS Internet Storm Center](https://isc.sans.edu/)

---

*この文書はパケットフィルタリングの基本概念を理解するための入門資料です。実際の実装や運用については、具体的な製品のドキュメントや専門的なトレーニングを参照してください。*
