# ARPキャッシュ入門

## 目次
1. [ARPとは？](#arpとは)
2. [ARPキャッシュとは？](#arpキャッシュとは)
3. [ARPの仕組み](#arpの仕組み)
4. [ARPキャッシュの役割](#arpキャッシュの役割)
5. [ARPキャッシュの確認方法](#arpキャッシュの確認方法)
6. [ARPキャッシュの問題と対策](#arpキャッシュの問題と対策)
7. [セキュリティの観点](#セキュリティの観点)
8. [実践的な例](#実践的な例)

## ARPとは？

**ARP（Address Resolution Protocol）**は、ネットワークにおいて「IPアドレス」と「MACアドレス」を対応付けるためのプロトコルです。

### IPアドレスとMACアドレスの違い

| 項目 | IPアドレス | MACアドレス |
|------|------------|-------------|
| **役割** | ネットワーク上の論理的な住所 | ネットワーク機器の物理的な識別子 |
| **例** | 192.168.1.100 | 00:11:22:33:44:55 |
| **変更可能性** | 変更可能 | 基本的に固定（変更可能な場合もある） |
| **管理レベル** | ネットワーク層（Layer 3） | データリンク層（Layer 2） |

### なぜARPが必要なのか？

コンピュータ同士が通信するとき、以下の流れで情報が送られます：

1. **アプリケーション**: 「192.168.1.100にデータを送りたい」
2. **ネットワーク層**: IPアドレスで宛先を指定
3. **データリンク層**: MACアドレスで物理的な送信先を特定
4. **物理層**: 実際にデータを送信

この流れで、**IPアドレスからMACアドレスを調べる**のがARPの役割です。

## ARPキャッシュとは？

**ARPキャッシュ（ARPテーブル）**は、過去に調べたIPアドレスとMACアドレスの対応関係を一時的に保存しておく仕組みです。

### ARPキャッシュが存在する理由

```
💡 例えで考えてみましょう

友達の家に行くとき：
- 初回：住所を調べて道順を確認（ARP要求）
- 2回目以降：覚えているのでそのまま行ける（ARPキャッシュ利用）

ARPキャッシュも同じで、一度調べた情報を覚えておくことで、
毎回問い合わせる手間を省きます。
```

### ARPキャッシュの利点

- **通信の高速化**: 毎回ARP要求を送らなくて済む
- **ネットワーク負荷の軽減**: 不要なブロードキャストを削減
- **効率的な通信**: すぐにデータ送信を開始できる

## ARPの仕組み

### 1. 初回通信時（ARPキャッシュが空の場合）

```
コンピュータA (192.168.1.10) → コンピュータB (192.168.1.20) に通信したい場合

1. ARP要求（ブロードキャスト）
   A: "192.168.1.20のMACアドレスを教えて！"
   
2. ARP応答（ユニキャスト）
   B: "192.168.1.20のMACアドレスは 00:11:22:33:44:55 です"
   
3. ARPキャッシュに記録
   A: "192.168.1.20 = 00:11:22:33:44:55" を覚えておく
   
4. データ送信開始
   A → B: 実際のデータを送信
```

### 2. 2回目以降の通信（ARPキャッシュ利用）

```
コンピュータA → コンピュータB への通信

1. ARPキャッシュを確認
   A: "192.168.1.20のMACアドレスは... 00:11:22:33:44:55だった！"
   
2. すぐにデータ送信
   A → B: ARP要求なしで直接データを送信
```

## ARPキャッシュの役割

### 1. パフォーマンスの向上

| 項目 | ARP要求あり | ARPキャッシュ利用 |
|------|-------------|-------------------|
| **通信開始まで** | 数ミリ秒〜数十ミリ秒 | 即座 |
| **ネットワーク負荷** | ブロードキャスト発生 | なし |
| **処理負荷** | ARP処理が必要 | キャッシュ参照のみ |

### 2. ネットワーク効率の改善

- **ブロードキャスト削減**: 不要なARP要求を防ぐ
- **帯域幅の節約**: 余計な通信を減らす
- **スイッチの負荷軽減**: 処理すべきフレーム数を削減

## ARPキャッシュの確認方法

### Windows

```cmd
# ARPキャッシュの表示
arp -a

# 特定のIPアドレスのARP情報を表示
arp -a 192.168.1.100

# ARPキャッシュをクリア
arp -d *

# 静的ARPエントリの追加
arp -s 192.168.1.100 00-11-22-33-44-55
```

### Linux/macOS

```bash
# ARPキャッシュの表示
arp -a

# または
ip neigh show

# ARPキャッシュをクリア
sudo arp -d -a

# 特定のエントリを削除
sudo arp -d 192.168.1.100

# 静的ARPエントリの追加
sudo arp -s 192.168.1.100 00:11:22:33:44:55
```

### 出力例の見方

```
# Windows
Interface: 192.168.1.10 --- 0x4
  Internet Address      Physical Address      Type
  192.168.1.1          00-11-22-33-44-55     dynamic
  192.168.1.20         aa-bb-cc-dd-ee-ff     dynamic
  192.168.1.255        ff-ff-ff-ff-ff-ff     static

# Linux
192.168.1.1 dev eth0 lladdr 00:11:22:33:44:55 REACHABLE
192.168.1.20 dev eth0 lladdr aa:bb:cc:dd:ee:ff STALE
```

**Type/状態の説明:**
- **dynamic**: 自動的に学習されたエントリ
- **static**: 手動で設定されたエントリ
- **REACHABLE**: 到達可能
- **STALE**: 古い情報（再確認が必要）

## ARPキャッシュの問題と対策

### 1. ARPキャッシュの有効期限

ARPキャッシュのエントリには有効期限があります：

| OS | デフォルト有効期限 |
|----|-------------------|
| **Windows** | 2分（使用されている場合は10分） |
| **Linux** | 30秒〜5分（設定により異なる） |
| **macOS** | 20分 |

### 2. よくある問題

#### 問題1: 古い情報による通信障害

```
状況：
- コンピュータBのネットワークカードを交換
- 新しいMACアドレスに変更された
- コンピュータAは古いMACアドレスをキャッシュしている

結果：
- AからBへの通信が失敗
- Bは新しいMACアドレスでARP応答するが、Aは古い情報を使用
```

**対策:**
```cmd
# ARPキャッシュをクリア
arp -d 192.168.1.20

# または全体をクリア
arp -d *
```

#### 問題2: ネットワーク構成変更時の問題

```
状況：
- ルーターの交換やIPアドレス変更
- DHCPによるIPアドレスの再割り当て
- ネットワーク機器の移動

対策：
1. ネットワーク構成変更時はARPキャッシュをクリア
2. 定期的なキャッシュの更新
3. 静的ARPエントリの見直し
```

### 3. ARPキャッシュの最適化

#### 適切なタイムアウト設定

```bash
# Linux での設定例
# /proc/sys/net/ipv4/neigh/default/ 配下の設定

# ベースタイマー（秒）
echo 30 > /proc/sys/net/ipv4/neigh/default/base_reachable_time

# ガベージコレクション間隔（秒）
echo 30 > /proc/sys/net/ipv4/neigh/default/gc_stale_time
```

## セキュリティの観点

### ARPスプーフィング攻撃

ARPキャッシュは**セキュリティ上の脆弱性**にもなり得ます。

#### 攻撃の仕組み

```
正常な状態：
コンピュータA: "192.168.1.1 = ルーターのMAC" をキャッシュ

攻撃者の偽装ARP応答：
攻撃者: "192.168.1.1 = 攻撃者のMAC" を送信

結果：
コンピュータA: 攻撃者を本物のルーターと認識
→ 全ての通信が攻撃者を経由（中間者攻撃）
```

#### 対策方法

1. **静的ARPエントリの設定**
```cmd
# 重要な機器（ルーターなど）は静的に設定
arp -s 192.168.1.1 00-11-22-33-44-55
```

2. **ARPスプーフィング検出ツールの使用**
- **arpwatch** (Linux)
- **XArp** (Windows)
- **ARPGuard** (マルチプラットフォーム)

3. **ネットワーク監視**
```bash
# ARPテーブルの変更を監視
tcpdump -i eth0 arp

# 不審なARP通信の検出
wireshark (GUIツール)
```

### セキュリティのベストプラクティス

1. **定期的なARPキャッシュの確認**
2. **不審なエントリの検出**
3. **重要な機器の静的ARP設定**
4. **ネットワークセグメンテーション**
5. **ARPスプーフィング検出システムの導入**

## 実践的な例

### 例1: 家庭内ネットワークでの確認

```cmd
# 1. 現在のARPキャッシュを確認
arp -a

# 出力例：
# Interface: 192.168.1.100 --- 0x4
#   Internet Address      Physical Address      Type
#   192.168.1.1          a0-b1-c2-d3-e4-f5     dynamic  ← ルーター
#   192.168.1.50         12-34-56-78-9a-bc     dynamic  ← 他のPC
#   192.168.1.200        ff-ee-dd-cc-bb-aa     dynamic  ← スマートフォン

# 2. 特定の機器にpingを送信してARPキャッシュを更新
ping 192.168.1.10

# 3. 新しいエントリが追加されたか確認
arp -a
```

### 例2: トラブルシューティング

```cmd
# 問題: 特定のサーバーに接続できない

# 1. ARPキャッシュを確認
arp -a | findstr "192.168.1.50"

# 2. 古いエントリを削除
arp -d 192.168.1.50

# 3. 再度接続を試行
ping 192.168.1.50

# 4. 新しいARPエントリを確認
arp -a | findstr "192.168.1.50"
```

### 例3: セキュリティチェック

```cmd
# 1. 現在のARPキャッシュを記録
arp -a > arp_baseline.txt

# 2. しばらく時間を置いて再度確認
arp -a > arp_current.txt

# 3. 変更を比較（Windows）
fc arp_baseline.txt arp_current.txt

# 4. 不審な変更がないかチェック
# - 同じIPアドレスに異なるMACアドレス
# - 知らないIPアドレスの追加
# - 重要な機器のMACアドレス変更
```

## まとめ

### ARPキャッシュの重要なポイント

1. **効率性**: 通信の高速化とネットワーク負荷の軽減
2. **一時性**: 有効期限があり、定期的に更新される
3. **透明性**: 通常はユーザーが意識する必要がない
4. **脆弱性**: セキュリティ攻撃の対象となる可能性
5. **管理の重要性**: 適切な監視と管理が必要

### 覚えておくべきコマンド

| 目的 | Windows | Linux/macOS |
|------|---------|-------------|
| **表示** | `arp -a` | `arp -a` または `ip neigh show` |
| **削除** | `arp -d [IP]` | `sudo arp -d [IP]` |
| **全削除** | `arp -d *` | `sudo arp -d -a` |
| **静的追加** | `arp -s [IP] [MAC]` | `sudo arp -s [IP] [MAC]` |

### 日常的な運用のコツ

1. **問題発生時はまずARPキャッシュをクリア**
2. **重要な機器は静的ARPエントリを検討**
3. **定期的なセキュリティチェック**
4. **ネットワーク構成変更時の注意**

ARPキャッシュは普段意識することは少ないですが、ネットワーク通信の基盤となる重要な仕組みです。基本的な仕組みを理解し、適切に管理することで、より安全で効率的なネットワーク環境を構築できます。
