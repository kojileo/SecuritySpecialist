# SPF入門

## SPFとは

**SPF（Sender Policy Framework）**は、メール送信者のなりすましを防ぐためのセキュリティ技術です。受信側のメールサーバーが、送信者のドメインが本当にそのメールを送信する権限があるかを確認できます。

## なぜSPFが必要なのか

### 問題
- 悪意のある第三者が、他人のドメインを偽ってメールを送信できる
- フィッシングメールやスパムメールが増加
- 受信者が本物か偽物か判断できない

### 解決策
SPFレコードを設定することで、そのドメインから送信を許可されたメールサーバーのみがメールを送信できるようになります。

## SPFレコードの仕組み

### DNSレコードとして設定
```
example.com. IN TXT "v=spf1 include:_spf.google.com ~all"
```

### 基本的な構文
- `v=spf1`: SPFのバージョン1を指定
- `include:`: 他のドメインのSPFレコードを参照
- `~all`: その他の送信元は「ソフトフェイル」として扱う

## 主要なSPFメカニズム

| メカニズム | 説明 | 例 |
|-----------|------|-----|
| `ip4:` | IPv4アドレスを指定 | `ip4:192.168.1.1` |
| `ip6:` | IPv6アドレスを指定 | `ip6:2001:db8::1` |
| `include:` | 他のドメインのSPFを参照 | `include:_spf.google.com` |
| `a:` | ドメインのAレコードを参照 | `a:mail.example.com` |
| `mx:` | ドメインのMXレコードを参照 | `mx:example.com` |
| `all` | その他のすべての送信元 | `~all`（ソフトフェイル） |

## 修飾子（Qualifier）

| 修飾子 | 意味 | 説明 |
|--------|------|------|
| `+` | パス | 送信を許可（デフォルト） |
| `-` | フェイル | 送信を拒否 |
| `~` | ソフトフェイル | 送信を疑わしいとして扱う |
| `?` | ニュートラル | 判定を保留 |

## 実装例

### 基本的なSPFレコード
```
v=spf1 ip4:192.168.1.100 ~all
```
- 192.168.1.100からの送信のみ許可
- その他はソフトフェイル

### Google Workspaceを使用する場合
```
v=spf1 include:_spf.google.com ~all
```

### 複数の送信元を許可する場合
```
v=spf1 ip4:192.168.1.100 include:_spf.google.com a:mail.example.com ~all
```

## SPFの確認方法

### 1. DNSレコードの確認
```bash
nslookup -type=TXT example.com
```

### 2. オンラインツール
- [SPF Record Testing Tools](https://www.kitterman.com/spf/validate.html)
- [MXToolbox SPF Checker](https://mxtoolbox.com/spf.aspx)

## 注意点

### よくある間違い
1. **複数のSPFレコード**: 1つのドメインに複数のSPFレコードは設定できない
2. **長すぎるレコード**: DNSの制限（255文字）を超えないよう注意
3. **includeの多用**: 10個以上のincludeは避ける

### ベストプラクティス
- 定期的にSPFレコードを確認・更新
- テスト環境で事前に検証
- ログを監視してSPFの動作を確認

## まとめ

SPFはメールセキュリティの基本的な技術で、ドメインのなりすましを防ぐ重要な役割を果たします。適切に設定することで、組織のメールセキュリティを大幅に向上させることができます。

### 次のステップ
- DMARCの設定（SPFと連携）
- DKIMの実装
- メール認証の総合的な監視
