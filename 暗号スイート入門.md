# 暗号スイート入門

## 暗号スイートとは

**暗号スイート（Cipher Suite）**は、暗号化通信で使用する暗号化アルゴリズムの組み合わせです。TLS/SSL通信において、データの暗号化、認証、整合性保証などに使用する複数の暗号化技術を一つのセットとして定義したものです。

## なぜ暗号スイートが必要なのか

### 問題
- 単一の暗号化アルゴリズムでは全ての要件を満たせない
- 暗号化、認証、整合性保証は異なる技術が必要
- 通信相手との互換性を確保する必要
- セキュリティレベルに応じた選択が必要

### 解決策
暗号スイートを使用することで、複数の暗号化技術を組み合わせて、安全で効率的な暗号化通信を実現できます。

## 暗号スイートの構成要素

### 1. 鍵交換アルゴリズム（Key Exchange）
```
[クライアント] ←→ [サーバー]
     ↓              ↓
 公開鍵の交換 → 共通鍵の生成
```

| アルゴリズム | 説明 | セキュリティレベル | 用途 |
|-------------|------|-------------------|------|
| **RSA** | 公開鍵暗号 | 中 | 一般的なWebサイト |
| **ECDHE** | 楕円曲線Diffie-Hellman | 高 | モダンなWebサイト |
| **DHE** | Diffie-Hellman | 高 | 高セキュリティ環境 |
| **PSK** | 事前共有鍵 | 中 | 組み込みシステム |

### 2. 認証アルゴリズム（Authentication）
```
[サーバー証明書] → [デジタル署名] → [クライアント認証]
```

| アルゴリズム | 説明 | セキュリティレベル | 用途 |
|-------------|------|-------------------|------|
| **RSA** | RSA署名 | 中 | 一般的な証明書 |
| **ECDSA** | 楕円曲線署名 | 高 | モダンな証明書 |
| **EdDSA** | Edwards曲線署名 | 高 | 最新の証明書 |

### 3. 暗号化アルゴリズム（Encryption）
```
[平文] → [暗号化] → [暗号文] → [復号化] → [平文]
```

| アルゴリズム | 鍵長 | セキュリティレベル | 用途 |
|-------------|------|-------------------|------|
| **AES-128** | 128bit | 高 | 一般的な暗号化 |
| **AES-256** | 256bit | 最高 | 高セキュリティ環境 |
| **ChaCha20** | 256bit | 高 | モバイル・組み込み |
| **3DES** | 168bit | 低 | レガシーシステム |

### 4. メッセージ認証コード（MAC）
```
[メッセージ] → [ハッシュ] → [MAC] → [検証]
```

| アルゴリズム | 説明 | セキュリティレベル | 用途 |
|-------------|------|-------------------|------|
| **HMAC-SHA256** | SHA-256ベース | 高 | 一般的なMAC |
| **HMAC-SHA384** | SHA-384ベース | 高 | 高セキュリティ環境 |
| **Poly1305** | 認証暗号 | 高 | ChaCha20と組み合わせ |

## 暗号スイートの表記法

### 1. 基本的な表記
```
TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
```

### 2. 各部分の説明
| 部分 | 説明 | 例 |
|------|------|-----|
| **TLS** | プロトコル | TLS |
| **ECDHE** | 鍵交換 | ECDHE |
| **RSA** | 認証 | RSA |
| **AES_256_GCM** | 暗号化 | AES-256-GCM |
| **SHA384** | MAC | HMAC-SHA384 |

### 3. よく使用される暗号スイート

| 暗号スイート | セキュリティレベル | 用途 |
|-------------|-------------------|------|
| **TLS_AES_256_GCM_SHA384** | 最高 | TLS 1.3 |
| **TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384** | 高 | モダンなWebサイト |
| **TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384** | 高 | 高セキュリティ環境 |
| **TLS_RSA_WITH_AES_256_CBC_SHA256** | 中 | レガシーシステム |
| **TLS_RSA_WITH_3DES_EDE_CBC_SHA** | 低 | 古いシステム |

## 暗号スイートの選択基準

### 1. セキュリティレベル
```
最高: TLS 1.3 + AES-256-GCM
高:   TLS 1.2 + ECDHE + AES-256-GCM
中:   TLS 1.2 + RSA + AES-256-CBC
低:   TLS 1.0 + 3DES
```

### 2. パフォーマンス
| 暗号スイート | 暗号化速度 | 鍵生成速度 | メモリ使用量 |
|-------------|-----------|-----------|-------------|
| **AES-GCM** | 高速 | 中 | 中 |
| **ChaCha20-Poly1305** | 高速 | 高速 | 低 |
| **AES-CBC** | 中 | 中 | 中 |
| **3DES** | 低速 | 中 | 中 |

### 3. 互換性
- **クライアント対応**: 古いブラウザとの互換性
- **サーバー対応**: サーバーソフトウェアの対応状況
- **ハードウェア対応**: CPUの暗号化支援機能

## 実装例

### 1. OpenSSLでの設定
```bash
# 高セキュリティな暗号スイートの設定
openssl s_server -cipher "ECDHE+AESGCM:ECDHE+CHACHA20:DHE+AESGCM:DHE+CHACHA20:!aNULL:!MD5:!DSS"

# 暗号スイートの確認
openssl ciphers -v 'ECDHE+AESGCM:ECDHE+CHACHA20'
```

### 2. Apacheでの設定
```apache
# /etc/apache2/sites-available/default-ssl.conf
SSLCipherSuite ECDHE+AESGCM:ECDHE+CHACHA20:DHE+AESGCM:DHE+CHACHA20:!aNULL:!MD5:!DSS
SSLHonorCipherOrder on
SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
```

### 3. Nginxでの設定
```nginx
# /etc/nginx/sites-available/default
ssl_ciphers ECDHE+AESGCM:ECDHE+CHACHA20:DHE+AESGCM:DHE+CHACHA20:!aNULL:!MD5:!DSS;
ssl_prefer_server_ciphers on;
ssl_protocols TLSv1.2 TLSv1.3;
```

### 4. Pythonでの実装
```python
import ssl
import socket

def create_secure_connection(host, port):
    """セキュアなTLS接続を作成"""
    context = ssl.create_default_context()
    
    # 暗号スイートの設定
    context.set_ciphers('ECDHE+AESGCM:ECDHE+CHACHA20')
    
    # プロトコルの設定
    context.minimum_version = ssl.TLSVersion.TLSv1_2
    context.maximum_version = ssl.TLSVersion.TLSv1_3
    
    # 接続の作成
    with socket.create_connection((host, port)) as sock:
        with context.wrap_socket(sock, server_hostname=host) as ssock:
            print(f"暗号スイート: {ssock.cipher()}")
            return ssock
```

## 暗号スイートの検証

### 1. オンラインツール
- **SSL Labs**: https://www.ssllabs.com/ssltest/
- **SSL Checker**: https://www.sslshopper.com/ssl-checker.html
- **Cipher Suite Checker**: https://ciphersuite.info/

### 2. コマンドラインツール
```bash
# OpenSSLでの確認
openssl s_client -connect example.com:443 -cipher 'ECDHE+AESGCM'

# nmapでの確認
nmap --script ssl-enum-ciphers -p 443 example.com

# testssl.shでの確認
./testssl.sh example.com
```

### 3. プログラムでの確認
```python
import ssl
import socket

def check_cipher_suites(host, port):
    """利用可能な暗号スイートを確認"""
    context = ssl.create_default_context()
    
    with socket.create_connection((host, port)) as sock:
        with context.wrap_socket(sock, server_hostname=host) as ssock:
            print(f"選択された暗号スイート: {ssock.cipher()}")
            print(f"プロトコル: {ssock.version()}")
            print(f"証明書: {ssock.getpeercert()}")
```

## セキュリティ考慮事項

### 1. 脆弱な暗号スイート
| 暗号スイート | 問題 | 推奨 |
|-------------|------|------|
| **RC4** | 脆弱性 | 使用禁止 |
| **3DES** | 脆弱性 | 使用禁止 |
| **MD5** | 脆弱性 | 使用禁止 |
| **SHA1** | 脆弱性 | 使用禁止 |

### 2. 推奨される暗号スイート
```
TLS 1.3:
- TLS_AES_256_GCM_SHA384
- TLS_CHACHA20_POLY1305_SHA256

TLS 1.2:
- TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
- TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
- TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256
```

### 3. 設定のベストプラクティス
- **Perfect Forward Secrecy**: 一時的な鍵の使用
- **強力な暗号化**: AES-256以上
- **安全なハッシュ**: SHA-256以上
- **プロトコルの制限**: TLS 1.2以上

## パフォーマンス最適化

### 1. ハードウェア支援
```bash
# AES-NIの確認
grep -m1 -o aes /proc/cpuinfo

# 暗号化支援機能の確認
openssl speed -evp aes-256-gcm
```

### 2. 設定の最適化
```nginx
# Nginxでの最適化設定
ssl_session_cache shared:SSL:10m;
ssl_session_timeout 10m;
ssl_session_tickets off;
ssl_stapling on;
ssl_stapling_verify on;
```

### 3. モニタリング
```python
# 暗号化処理の監視
import time
import ssl

def monitor_ssl_performance():
    """SSL処理のパフォーマンスを監視"""
    start_time = time.time()
    
    # SSL接続の作成
    context = ssl.create_default_context()
    # ... 接続処理 ...
    
    end_time = time.time()
    print(f"SSL接続時間: {end_time - start_time:.3f}秒")
```

## まとめ

暗号スイートは、安全な暗号化通信を実現するための重要な技術です。適切な選択と設定により、セキュリティとパフォーマンスの両方を最適化できます。

### 次のステップ
- 現在の暗号スイートの確認
- セキュリティレベルの向上
- パフォーマンスの最適化
- 定期的なセキュリティ監査
