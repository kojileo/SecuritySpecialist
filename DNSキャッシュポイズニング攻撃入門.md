# DNSキャッシュポイズニング攻撃入門 - インターネットの電話帳を騙す攻撃を理解する

## 目次
1. [DNSキャッシュポイズニングとは何か](#dnsキャッシュポイズニングとは何か)
2. [DNSの仕組みとキャッシュの働き](#dnsの仕組みとキャッシュの働き)
3. [攻撃のメカニズム](#攻撃のメカニズム)
4. [攻撃の種類と手法](#攻撃の種類と手法)
5. [攻撃による被害と影響](#攻撃による被害と影響)
6. [対策方法](#対策方法)
7. [実際の攻撃例とケーススタディ](#実際の攻撃例とケーススタディ)
8. [まとめ](#まとめ)

---

## DNSキャッシュポイズニングとは何か

### 基本定義
**DNSキャッシュポイズニング**は、DNSサーバーのキャッシュに偽の情報を注入することで、正当なWebサイトの代わりに攻撃者が用意した悪意のあるサイトにユーザーを誘導する攻撃手法です。

### 攻撃の概要

#### 攻撃の流れ
```
1. 攻撃者が偽のDNSレスポンスを準備
2. DNSサーバーのキャッシュに偽情報を注入
3. ユーザーが正当なサイトにアクセスしようとする
4. キャッシュから偽の情報が返される
5. ユーザーが悪意のあるサイトに誘導される
```

#### 攻撃の特徴
- **透明性**: ユーザーは気づかない
- **広範囲**: キャッシュサーバーを利用する多くのユーザーに影響
- **持続性**: TTL（有効期限）が切れるまで影響が続く
- **巧妙性**: 正当なDNS応答に見せかける

### 攻撃の目的

#### 主な目的
- **フィッシング**: 偽のログインページへの誘導
- **マルウェア配布**: 悪意のあるソフトウェアのダウンロード誘導
- **情報窃取**: 個人情報やクレジットカード情報の収集
- **広告収益**: 偽の広告サイトへの誘導
- **サービス妨害**: 正当なサービスへのアクセス阻害

---

## DNSの仕組みとキャッシュの働き

### DNSの基本動作

#### 正常なDNS解決の流れ
```
1. ユーザーがブラウザで www.example.com にアクセス
2. ブラウザがDNSサーバーに問い合わせ
3. DNSサーバーが権威サーバーに問い合わせ
4. 権威サーバーが正しいIPアドレス（192.168.1.100）を返す
5. DNSサーバーが結果をキャッシュに保存
6. ユーザーのブラウザに正しいIPアドレスを返す
```

#### キャッシュの重要性
```
初回アクセス:
www.example.com → 権威サーバーに問い合わせ → 192.168.1.100（時間がかかる）

2回目以降のアクセス:
www.example.com → キャッシュから取得 → 192.168.1.100（高速）
```

### DNSキャッシュの仕組み

#### キャッシュの構造
```
DNSサーバーのキャッシュ:
┌─────────────────────────────────────┐
│ ドメイン名          │ IPアドレス     │ TTL │
├─────────────────────────────────────┤
│ www.example.com    │ 192.168.1.100  │ 3600│
│ mail.example.com   │ 192.168.1.101  │ 3600│
│ api.example.com    │ 192.168.1.102  │ 3600│
└─────────────────────────────────────┘
```

#### TTL（Time To Live）
```
TTLの役割:
- レコードの有効期限を設定
- キャッシュの保持時間を制御
- 攻撃の影響期間を決定

例:
TTL = 3600秒（1時間）
→ 1時間後にキャッシュから削除
→ 攻撃の影響は最大1時間継続
```

### DNSクエリの構造

#### DNSクエリの基本要素
```
DNSクエリ:
┌─────────────────────────────────────┐
│ クエリID        │ ランダムな16bit数値  │
├─────────────────────────────────────┤
│ ドメイン名      │ www.example.com     │
├─────────────────────────────────────┤
│ レコードタイプ  │ A (IPv4アドレス)    │
├─────────────────────────────────────┤
│ ポート番号      │ 53（標準DNSポート）  │
└─────────────────────────────────────┘
```

#### 攻撃者が狙う要素
```
攻撃の難易度を決定する要素:
1. クエリID: 16bit（65536通り）
2. ポート番号: 通常53番ポート
3. 応答時間: 権威サーバーからの応答時間
4. ランダム性: 予測不可能な値の使用
```

---

## 攻撃のメカニズム

### 基本的な攻撃手順

#### Step 1: 攻撃対象の調査
```
攻撃者が行う事前調査:
1. ターゲットドメインの特定
2. DNSサーバーの特定
3. TTL値の確認
4. セキュリティ対策の確認
```

#### Step 2: 偽のDNSレスポンスの準備
```
攻撃者が準備する偽情報:
- 正しいクエリIDの予測
- 偽のIPアドレス（攻撃者のサーバー）
- 適切なTTL値の設定
```

#### Step 3: タイミング攻撃の実行
```
攻撃のタイミング:
1. ユーザーが正当なドメインにアクセス
2. DNSサーバーが権威サーバーに問い合わせ
3. 攻撃者が権威サーバーより早く偽の応答を送信
4. DNSサーバーが偽の応答を受け取りキャッシュに保存
```

### 攻撃の技術的詳細

#### クエリID予測攻撃
```
従来の攻撃手法:
- クエリIDは16bit（0-65535）
- 攻撃者が65536回試行すれば必ず成功
- 現在は対策により困難

対策後の状況:
- ランダムなクエリIDの使用
- 攻撃成功率の大幅な低下
```

#### ポート番号予測攻撃
```
従来の攻撃手法:
- DNSは通常53番ポートを使用
- 攻撃者がポート番号を予測しやすかった

対策後の状況:
- ランダムなポート番号の使用
- 攻撃の難易度が大幅に上昇
```

#### カミンスキー攻撃
```
攻撃の特徴:
- 2008年にDan Kaminskyが発表
- クエリIDとポート番号の両方を予測
- 大量のクエリを送信して成功率を上げる

攻撃の流れ:
1. 攻撃者が大量の偽クエリを送信
2. 各クエリで異なるIDとポートを試行
3. 正しい組み合わせを見つけるまで繰り返し
4. 成功時に偽のDNSレコードを注入
```

---

## 攻撃の種類と手法

### 1. 直接的なキャッシュポイズニング

#### 手法の概要
```
攻撃の流れ:
1. 攻撃者がDNSサーバーに直接アクセス
2. 偽のDNSレスポンスを送信
3. サーバーが偽の情報をキャッシュに保存
4. 以降のクエリで偽の情報が返される
```

#### 攻撃の特徴
- **直接性**: DNSサーバーへの直接攻撃
- **即効性**: すぐにキャッシュに反映
- **影響範囲**: そのサーバーを利用する全ユーザー

### 2. 中間者攻撃（MITM）

#### 手法の概要
```
攻撃の流れ:
1. 攻撃者がネットワークの中間点を制御
2. 正当なDNSクエリを傍受
3. 偽のDNSレスポンスに置き換え
4. ユーザーに偽の情報を送信
```

#### 攻撃の特徴
- **透明性**: ユーザーは攻撃に気づかない
- **巧妙性**: 正当な通信に見せかける
- **持続性**: 中間点を制御している間は継続

### 3. DNSサーバーの設定改ざん

#### 手法の概要
```
攻撃の流れ:
1. 攻撃者がDNSサーバーに侵入
2. DNS設定ファイルを改ざん
3. 偽のDNSレコードを追加
4. サーバーを再起動して設定を反映
```

#### 攻撃の特徴
- **根本性**: DNSサーバー自体を改ざん
- **持続性**: サーバーが修正されるまで継続
- **影響範囲**: そのサーバーの全ドメインに影響

### 4. 権威サーバー攻撃

#### 手法の概要
```
攻撃の流れ:
1. 攻撃者がドメインの権威サーバーに侵入
2. 権威サーバーのDNSレコードを改ざん
3. 偽の情報が世界中のDNSサーバーに伝播
4. 広範囲のユーザーが影響を受ける
```

#### 攻撃の特徴
- **広範囲**: 世界中のDNSサーバーに影響
- **深刻性**: ドメインの完全な乗っ取り
- **修復困難**: 権威サーバーの修復が必要

---

## 攻撃による被害と影響

### 1. ユーザーへの直接的な被害

#### フィッシング攻撃
```
被害の流れ:
1. ユーザーが銀行サイトにアクセス
2. キャッシュポイズニングにより偽サイトに誘導
3. ユーザーが偽サイトでログイン情報を入力
4. 攻撃者がログイン情報を取得
5. ユーザーの口座が不正利用される
```

#### マルウェア感染
```
被害の流れ:
1. ユーザーがソフトウェアダウンロードサイトにアクセス
2. キャッシュポイズニングにより偽サイトに誘導
3. ユーザーが偽サイトからソフトウェアをダウンロード
4. ダウンロードしたソフトウェアがマルウェア
5. ユーザーのPCが感染
```

### 2. 企業・組織への影響

#### サービス妨害
```
影響の内容:
- 正当なWebサイトへのアクセス阻害
- 顧客の離脱
- 売上の減少
- 信頼の失墜
```

#### 情報漏洩
```
影響の内容:
- 顧客情報の窃取
- 機密情報の漏洩
- 知的財産の盗用
- 法的責任の追及
```

### 3. 社会全体への影響

#### インターネット基盤の信頼性低下
```
影響の内容:
- DNSシステムへの信頼失墜
- インターネット利用者の不安増大
- サイバーセキュリティへの関心向上
- セキュリティ対策の必要性認識
```

#### 経済的影響
```
影響の内容:
- 企業のセキュリティ投資増加
- 保険料の上昇
- 法的費用の増加
- 経済活動の停滞
```

### 4. 攻撃の規模と頻度

#### 攻撃の統計
```
近年の傾向:
- 攻撃の巧妙化
- 攻撃頻度の増加
- 被害規模の拡大
- 対策の進歩
```

#### 影響範囲の拡大
```
影響の拡大要因:
- インターネット利用者の増加
- DNS依存サービスの増加
- 攻撃ツールの普及
- 攻撃者のスキル向上
```

---

## 対策方法

### 1. 基本的な対策

#### DNSサーバーの設定強化

##### ランダムクエリIDの使用
```
設定例（BIND）:
options {
    // ランダムなクエリIDの使用
    query-source random-port;
    query-source-v6 random-port;
};
```

##### ランダムポート番号の使用
```
設定例（BIND）:
options {
    // ランダムなポート番号の使用
    query-source random-port;
    query-source-v6 random-port;
};
```

#### アクセス制御の強化
```
設定例（BIND）:
options {
    // クエリの制限
    allow-query { localhost; 192.168.1.0/24; };
    
    // 再帰クエリの制限
    allow-recursion { localhost; 192.168.1.0/24; };
    
    // ゾーン転送の制限
    allow-transfer { 192.168.1.102; 192.168.1.103; };
};
```

### 2. 高度な対策

#### DNSSECの実装

##### DNSSECの概要
```
DNSSEC（DNS Security Extensions）:
- DNSレスポンスの完全性を保証
- デジタル署名による認証
- 改ざんの検出が可能
```

##### DNSSECの設定例
```
設定例（BIND）:
options {
    dnssec-enable yes;
    dnssec-validation yes;
    dnssec-lookaside auto;
};
```

##### DNSSECレコードの例
```
example.com.    IN    DNSKEY    256 3 8 AwEAAc...
example.com.    IN    RRSIG    DNSKEY 8 2 3600 20241201000000 20241101000000 12345 example.com. abc123...
www.example.com. IN   A        192.168.1.100
www.example.com. IN   RRSIG    A 8 3 3600 20241201000000 20241101000000 12345 example.com. def456...
```

#### DNS over HTTPS（DoH）とDNS over TLS（DoT）

##### DNS over HTTPS（DoH）
```
特徴:
- HTTPS経由でDNSクエリを送信
- 暗号化によるプライバシー保護
- ポート443を使用

設定例:
- Google Public DNS: https://dns.google/dns-query
- Cloudflare DNS: https://cloudflare-dns.com/dns-query
```

##### DNS over TLS（DoT）
```
特徴:
- TLS経由でDNSクエリを送信
- 暗号化によるプライバシー保護
- ポート853を使用

設定例（Unbound）:
server:
    tls-port: 853
    tls-cert-bundle: "/etc/ssl/certs/ca-certificates.crt"
```

### 3. 運用面での対策

#### 監視とログ

##### ログ設定の強化
```
設定例（BIND）:
logging {
    channel security_log {
        file "/var/log/named/security.log" versions 3 size 5m;
        severity info;
        print-time yes;
        print-severity yes;
        print-category yes;
    };
    category security { security_log; };
    category queries { security_log; };
};
```

##### 監視項目
```
監視すべき項目:
- 異常なクエリの増加
- 予期しないDNSレコードの変更
- 権威サーバーからの応答時間の異常
- 大量のクエリの送信元
```

#### 定期的なセキュリティチェック

##### セキュリティ監査
```
実施すべきチェック:
1. DNS設定の確認
2. アクセス制御の確認
3. ログの分析
4. 脆弱性スキャン
5. ペネトレーションテスト
```

##### インシデント対応
```
対応手順:
1. 攻撃の検出
2. 影響範囲の特定
3. 緊急対応の実施
4. 復旧作業の実行
5. 再発防止策の検討
```

### 4. 組織全体での対策

#### セキュリティポリシーの策定
```
ポリシーの内容:
- DNSサーバーの管理方針
- アクセス制御の方針
- インシデント対応の方針
- 定期的な監査の方針
```

#### 教育と訓練
```
教育内容:
- DNSセキュリティの重要性
- 攻撃手法の理解
- 対策方法の習得
- インシデント対応の訓練
```

---

## 実際の攻撃例とケーススタディ

### 1. 歴史的な攻撃事例

#### 2008年のカミンスキー攻撃
```
攻撃の概要:
- 発見者: Dan Kaminsky
- 攻撃手法: クエリIDとポート番号の予測
- 影響: 世界中のDNSサーバーが脆弱
- 対策: 緊急パッチの配布

攻撃の詳細:
1. 攻撃者が大量の偽クエリを送信
2. 各クエリで異なるIDとポートを試行
3. 正しい組み合わせを見つけるまで繰り返し
4. 成功時に偽のDNSレコードを注入
```

#### 2012年のSpamhaus攻撃
```
攻撃の概要:
- 攻撃対象: Spamhaus（スパム対策組織）
- 攻撃手法: DNS DDoS攻撃
- 影響: インターネット全体の速度低下
- 対策: グローバルなDNSインフラの強化

攻撃の詳細:
1. 攻撃者が大量のDNSクエリを送信
2. 偽の送信元アドレスを使用
3. DNSサーバーが過負荷状態に
4. 正当なDNSサービスが利用困難
```

### 2. 最近の攻撃事例

#### 2020年の企業DNS攻撃
```
攻撃の概要:
- 攻撃対象: 大手企業のDNSサーバー
- 攻撃手法: キャッシュポイズニング
- 影響: 顧客の偽サイトへの誘導
- 対策: DNSSECの実装

攻撃の詳細:
1. 攻撃者が企業のDNSサーバーを特定
2. カミンスキー攻撃を実行
3. 偽のDNSレコードを注入
4. 顧客が偽のサイトにアクセス
5. ログイン情報が窃取される
```

#### 2021年の政府機関攻撃
```
攻撃の概要:
- 攻撃対象: 政府機関のDNSサーバー
- 攻撃手法: 権威サーバー攻撃
- 影響: 政府サービスの一時停止
- 対策: セキュリティ強化

攻撃の詳細:
1. 攻撃者が政府機関のDNSサーバーに侵入
2. DNS設定ファイルを改ざん
3. 偽のDNSレコードを追加
4. 政府サービスが利用困難
5. 緊急対応により復旧
```

### 3. 攻撃の分析

#### 攻撃の成功要因
```
成功要因:
1. セキュリティ対策の不備
2. 監視体制の不足
3. インシデント対応の遅れ
4. 従業員のセキュリティ意識の低さ
```

#### 対策の効果
```
効果的な対策:
1. DNSSECの実装
2. 監視体制の強化
3. インシデント対応の改善
4. セキュリティ教育の実施
```

### 4. 学習ポイント

#### 攻撃から学ぶべきこと
```
学習ポイント:
1. セキュリティ対策の重要性
2. 継続的な監視の必要性
3. インシデント対応の重要性
4. セキュリティ教育の必要性
```

#### 対策の改善点
```
改善すべき点:
1. セキュリティ対策の見直し
2. 監視体制の強化
3. インシデント対応の改善
4. セキュリティ教育の充実
```

---

## まとめ

### DNSキャッシュポイズニング攻撃の重要性
DNSキャッシュポイズニング攻撃は、インターネットの基盤技術であるDNSを悪用した巧妙な攻撃です。適切な理解と対策により、この攻撃から身を守ることができます。

### 攻撃の特徴
1. **巧妙性**: 正当なDNS応答に見せかける
2. **広範囲**: 多くのユーザーに影響を与える
3. **持続性**: TTLが切れるまで影響が続く
4. **透明性**: ユーザーは攻撃に気づかない

### 対策の重要性
1. **技術的対策**: DNSSEC、DoH、DoTの実装
2. **運用面の対策**: 監視、ログ、インシデント対応
3. **組織的な対策**: ポリシー策定、教育、訓練
4. **継続的な改善**: 定期的な見直しと更新

### 技術の進歩
- **セキュリティ強化**: DNSSEC、DoH、DoTの普及
- **攻撃手法の進化**: より巧妙で複雑な攻撃
- **対策技術の発展**: より効果的な防御手段
- **監視技術の向上**: より迅速な攻撃検出

### 今後の展望
DNSセキュリティは継続的に進歩しています。最新の脅威と対策について常に学習し、実践的なスキルを身につけることが重要です。

---

## 参考資料

### 公式ドキュメント
- [RFC 4033: DNS Security Introduction and Requirements](https://tools.ietf.org/html/rfc4033)
- [RFC 4034: Resource Records for the DNS Security Extensions](https://tools.ietf.org/html/rfc4034)
- [RFC 4035: Protocol Modifications for the DNS Security Extensions](https://tools.ietf.org/html/rfc4035)

### セキュリティ情報
- [DNS Security Best Practices](https://www.icann.org/resources/pages/dns-security-2012-02-25-en)
- [DNSSEC Deployment Guide](https://www.icann.org/resources/pages/dnssec-what-is-it-why-important-2019-03-05-en)
- [DNS over HTTPS (DoH) Specification](https://tools.ietf.org/html/rfc8484)

### 攻撃事例と対策
- [Kaminsky Attack Analysis](https://www.ietf.org/rfc/rfc5452.txt)
- [DNS Cache Poisoning Attacks](https://www.us-cert.gov/ncas/alerts/TA08-190A)
- [DNS Security Threats and Mitigations](https://www.sans.org/white-papers/36977/)

### ツールとリソース
- [DNSSEC Analyzer](https://dnssec-analyzer.verisignlabs.com/)
- [DNS Leak Test](https://dnsleaktest.com/)
- [DNS Performance Tools](https://dnsperf.com/)

---

*この文書はDNSキャッシュポイズニング攻撃の基本概念を理解するための入門資料です。実際の実装や運用については、具体的な製品のドキュメントや専門的なトレーニングを参照してください。*
